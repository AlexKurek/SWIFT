\documentclass[fleqn, usenatbib, useAMS, a4paper]{mnras}
\usepackage{graphicx}
\usepackage{amsmath,paralist,xcolor,xspace,amssymb}
\usepackage{times}
\usepackage{comment}
\usepackage[super]{nth}

\newcommand{\todo}[1]{{\textcolor{red}{TODO: #1}\\}}
\newcommand{\swift}{{\sc Swift}\xspace}

\newcommand{\D}[2]{\frac{d#1}{d#2}}
\newcommand{\LL}{\left(}
\newcommand{\RR}{\right)}

\title{Integration scheme for cooling}
\author{Alexei Borissov, Matthieu Schaller}

\begin{document}

\maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Basic principles}

\subsection{Isochoric cooling}

\todo{MATTHIEU: Discuss the fact that we want to do cooling at constant
  density.}

\subsection{Time integration}

We want to compute the change in internal energy of a given particle
due to the interaction of the gas with the background radiation. More
specifically we want to integrate the following equation:
\begin{equation}
  u_{\rm final} \equiv u(t+\Delta t) = u(t) + \left(\frac{\partial u}{\partial t}\bigg|_{\rm
    hydro} + \frac{\partial u}{\partial t}\bigg|_{\rm cooling}\right)
  \times \Delta t.
\end{equation}
The first derivative is given by the SPH scheme, the second one is
what we are after here. We start by computing the internal energy the
particle would have in the absence of cooling:
\begin{equation}
  u_0 \equiv u(t) + \frac{\partial u}{\partial t}\bigg|_{\rm
    hydro} \times \Delta t.
\end{equation}
We then proceed to solve the implicit equation
\begin{equation}
 u_{\rm final} = u_0 + \lambda(u_{\rm final}) \Delta t,
\end{equation}
where $\lambda$ is the cooling rate\footnote{Note this is not the
  physical cooling rate $\Lambda/n_{\rm H}^2$ that is commonly
  used. This is the change in energy over time $\frac{\partial
    u}{\partial t}\big|_{\rm cool}$ from all the channels
  including all the multiplicative factors coming in front of the
  physical $\Lambda$.}, which for a given particle varies
only with respect to $u$ throughout the duration of the timestep. The
other dependencies of $\lambda$ (density, metallicity and redshift)
are kept constant over the course of $\Delta t$. Crucially, we want to
evaluate $\lambda$ at the end of the time-step. Once a solution to this
implicit problem has been found, we get the total cooling rate:
\begin{equation}
  \frac{\partial u}{\partial t}\bigg|_{\rm total} \equiv \frac{u_{\rm final} -
    u(t)}{\Delta t},
\end{equation}
leading to the following total equation of motion for internal energy:
\begin{equation}
  u(t+\Delta t) = u(t) + \frac{\partial u}{\partial t}\bigg|_{\rm
    total} \times \Delta t.
\end{equation}
The time integration is then performed in the regular time integration
section of the code. Note that, as expected, if $\lambda=0$ the whole
processes reduces to a normal hydro-dynamics only time integration of
the internal energy.

Finally, for schemes evolving entropy $A$ instead of internal energy
$u$ (or for that matter any other thermodynamic quantity), we convert
the entropy derivative coming from the hydro scheme to an internal
energy derivative, solve the implicit cooling problem using internal
energies and convert the total time derivative back to an entropy
derivative. Since we already assume that cooling is performed at
constant density, there is no loss in accuracy happening via this
conversion procedure.

\subsubsection{Energy floor and prediction step}

In most applications, the cooling is not allowed to bring the internal
energy below a certain value $u_{\rm min}$, usually expressed in the
form of a minimal temperature. Additionally, and even in the absence
of such a temperature floor, we must ensure that the energy does not
become negative.

Since the time-step size is not chosen in a way to fulfil these
criteria, we have to limit the total rate of change of energy such
that the limits are not reached. In practice this means modifying
$\frac{\partial u}{\partial t}\big|_{\rm total}$ such that
\begin{equation}
  u(t) + \frac{\partial u}{\partial t}\bigg|_{\rm total} \times \Delta t \geq
  u_{\rm min}
\end{equation}
is true. In the vast majority of cases, there is no need to modify the
energy derivative but this may be necessary for some rapidly cooling
particles.

The time integration uses a leapfrog algorithm in its
``Kick-Drift-Kick'' form. In the cases, where the time-step is
constant, the condition as written above would be sufficient, however
with variable $\Delta t$ this needs modifying. If the next time-step
of a particle decreases in size, then the condition above will remain
true. However, if the time-step size increases then we may violate the
condition and integrate the energy to a value below $u_{\rm min}$. The
time-step size is chosen in-between the application of the two kick
operators\footnote{Effectively creating the chain
  ``Kick-Drift-Kick-Timestep'', where the last operation fixes the
  time-step size for the next kick-drift-kick cycle.}. We hence have
to ensure that the integration of one half of the current step (the
second kick) and one half of the next step (the first kick) does not
lead to a value below the allowed minimum. In \swift, we do not allow
the time-step to increase by more than a factor of $2$. This implies
that we will at most integrate the internal energy forward in time for
$1.5\Delta t$, where $\Delta t$ is the current value of the time-step
size we used in all the equations thus far. An additional subtlety
does, however, enter the scheme. The internal energy is not just used
in the Kick operator. Because of the needs of the SPH scheme, the
particles have to carry an estimate of the entropy at various points
in time inside the step of this particle. This is especially important
for inactive particles that act as sources for neighbouring active
particles. We must hence not only protect for the next half-kick, we
must also ensure that the value we estimated will be valid over the
next drift step as well. This means completing the current half-kick
and the next full drift, which could in principle double in size; this
implies checking the limits over the next $2.5\Delta t$. However, for
that variable, since it is an extrapolation and not the actual
variable we integrate forward in time, we do not need to enforce the
$u_{\rm min}$ limit. We must only ensure that the energy remains
positive. Combining those two conditions, we conclude that we must
enforce two limits:
\begin{equation}
  \left\lbrace
  \begin{array}{ll}
  \displaystyle\frac{\partial u}{\partial t}\bigg|_{\rm total}  \geq
  -\displaystyle\frac{u(t) - u_{\rm min} }{1.5 \Delta t}, \Bigg.  \\
  \displaystyle\frac{\partial u}{\partial t}\bigg|_{\rm total}  \geq
  -\displaystyle\frac{u(t) - u_{\rm min} }{(2.5 + \epsilon) \Delta t},  
  \end{array}
  \right.
\end{equation}
where in the second equation we added a small value $\epsilon$ to
ensure that we will not get negative values because of rounding errors.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Solution to the implicit cooling problem}

\subsection{Explicit solver}

\todo{Explain the explicit solver}

\subsection{Newton-Raphson method}

To prevent the occurance of negative internal energies during the
calculation we introduce $x = \log u$, so that we need to solve
\begin{equation}\label{fx-eq}
f(x) = e^x - u_0 - \lambda(e^x) dt = 0.
\end{equation}
Using Newton's method we obtain consecutive approximations of the root
of $f$ by the formula $x_{n+1} = x_n - f(x_n)/f'(x_n)$. This leads to
\begin{equation}
x_{n+1} = x_n - \frac{1 - u_0 e^{-x_n} -\lambda(e^{x_n})e^{-x_n}dt}{1
  - \frac{d\lambda}{du}(e^{x_n}) dt}.
\end{equation}
We obtain the gradient by
\begin{equation}
  \D \lambda u = \frac{\lambda(u_{high,n})
    - \lambda(u_{low,n})}{u_{high,n} - u_{low,n}},
\end{equation}
where $u_{\rm high,n}$ and $ u_{\rm low,n}$ are values of the internal
energy grid bracketing the current iteration of the value of the
internal energy ($u_n = e^{x_n}$) in Newton's method (i.e. $u_{high,n}
\ge u_n \ge u_{low,n}$).

%\begin{figure} \begin{center} \includegraphics[width =
%0.7\textwidth]{typical_fx} \caption{Relationship of $\log|f(x)|$ from
%Equation \ref{fx-eq} to the logarithm of temperature for multiple
%values $u_0$. Solid lines indicate where the value of $f(x)$ is
%negative, while for dashed lines $f(x)$ is positive. A hydrogen
%number density of $10^{-1}$ cm$^{-1}$, solar abundances and redshift
%0 are used for evaluating the cooling
%rate.}  \label{fx} \end{center} \end{figure}

The root of $f$ tends to be near the location of maximum gradient, so
the initial guess for the Newton's method is chosen to be the location
where $g(x) = e^x - u_0 - \lambda_h(e^x) dt$ has the greatest slope,
with $\lambda_h$ being the contribution to the cooling from hydrogen
and helium. Since the cooling rate is dominated by hydrogen and helium
at lower temperatures, this is a suitable way of approximating the
equilibrium temperature, and supplying a guess to the Newton iteration
scheme.

A particle is considered to have converged if the relative error in
the internal energy is sufficiently small. This can be formulated as
\begin{align*}
\frac{u_{n+1} - u_n}{u_{n+1}} &< C \\
u_{n+1} - u_n &< Cu_{n+1} \\
\LL 1-C\RR u_{n+1} &< u_n \\
\frac{u_{n+1}}{u_n} &< \frac{1}{1-C} \\
x_{n+1} - x_n = \log\frac{u_{n+1}}{u_n} &< -\log\LL 1-C \RR \simeq C.
\end{align*}
Since the grid spacing in the internal energy of the Eagle tables is
0.045 in $\log_{10}u$ we take $C = 10^{-2}$.

\subsection{Bissection method}

\todo{Explain the bissection method}

\section{EAGLE cooling tables}

\todo{Summarize the content of the Wiersma tables.}
\todo{Summarize the high-redshift tables.}
\todo{Explain the Compton-cooling contribution.}

\section{Co-moving time integration}

In the case of cosmological simulations, the equations need to be
slightly modified to take into account the expansion of the
Universe. The code uses the comoving internal energy $u' =
a(t)^{3(\gamma-1)}u$ or comoving entropy $A'=A$ as thermodynamic
variable. The equation of motion for the variable are then modified
and take the following form:
\begin{equation}
  \frac{\partial u'_i}{\partial t} = \frac{\partial u'_i}{\partial
    t}\bigg|_{\rm hydro}  = \frac{1}{a(t)^2} Y'_i(t)\big|_{\rm
    hydro},
\end{equation}
where $Y_i$ is computed from the particle itself and its neighbours
and corresponds to the change in internal energy due to hydrodynamic
forces. We then integrate the internal energy forward in time using
\begin{equation}
  u'_i(t+\Delta t) = u'_i(t) + Y'_i(t)\big|_{\rm hydro} \times \underbrace{\int_t^{t+\Delta t}
  \frac{1}{a(t)^2} dt}_{\Delta t_{\rm therm}}.
\end{equation}
The exact same equations apply in the case of a hydrodynamics scheme
evolving entropy (see cosmology document). We note that this is
different from the choice made in Gadget where there is no $a^{-2}$
term as it is absorbed in the definition in $Y'_i$ itself. As a
consequence $\Delta t_{\rm therm}$ is just $\Delta t$.

In order to compute the
cooling rate of a particle, we convert quantities to physcial
coordinates. Given the appearence of scale-factors in some of these
equations, we have to be careful to remain consistent throughout. We
start by constructing the co-moving internal energy at the end of the
time-step in the absence of cooling:
\begin{equation}
  u'_0 \equiv u'(t) + Y'_i(t)\big|_{\rm hydro} \times \Delta t_{\rm therm},
\end{equation}
which we then convert into a physical internal energy alongside the
thermal energy at the current time:
\begin{align}
  u(t) &= a^{3(1-\gamma)}u'(t),\\
  u_0 &= a^{3(1-\gamma)}u'_0.
\end{align}
We can then solve the implicit cooling problem in the same way as in
the non-comoving case and obtain
\begin{equation}
  u_{\rm final} = u_0 + \lambda(u_{\rm final}) \Delta t.
\end{equation}
We note that the $\Delta t$ here is the actual time between the start
and end of the step; unlike $\Delta t_{\rm therm}$ there are no
scale-factors entering that term. The solution to the implicit problem
in physical coordinates yields the definition of the total time
derivative of internal energy:
\begin{equation}
  \frac{\partial u}{\partial t}\bigg|_{\rm total} \equiv \frac{u_{\rm final} -
    u(t)}{\Delta t}.
\end{equation}
This allows us to construct the total eveolution of co-moving energy:
\begin{equation}
  Y'_i(t)\big|_{\rm total} = a^{3(\gamma-1)} \times \frac{\Delta t}{\Delta
    t_{\rm therm}} \times
  \frac{\partial u}{\partial t}\bigg|_{\rm total},
\end{equation}
where the first term is is the conversion from physical to co-moving
internal energy and the second term is required by our definition of
our time integration opertator. The time integration routine then performs the
same calculation as in the non-cooling case:
\begin{equation}
  u'_i(t+\Delta t) = u'_i(t) + Y'_i(t)\big|_{\rm total} \times {\Delta t_{\rm therm}}.
\end{equation}
\end{document}
